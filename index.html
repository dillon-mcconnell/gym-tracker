<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f5f5f7">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gym Tracker">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <title>Gym Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }
    #root { min-height: 100vh; }
    input, button, textarea { -webkit-appearance: none; appearance: none; }
    button:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script>
    const { useState, useEffect, createElement: h } = React;
    
    // GitHub storage implementation
    const GITHUB_CONFIG = {
      owner: 'dillon-mcconnell',
      repo: 'gym-tracker',
      branch: 'main',
      dataFile: 'gym-data.json'
    };

    class GitHubStorage {
      constructor() {
        this.token = localStorage.getItem('github_token');
        this.cache = null;
      }

      setToken(token) {
        this.token = token;
        localStorage.setItem('github_token', token);
      }

      hasToken() {
        return !!this.token;
      }

      async getData() {
        if (!this.token) {
          console.log('No token, using localStorage');
          return this.getLocalData();
        }

        try {
          const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`;
          const response = await fetch(url, {
            headers: {
              'Authorization': `token ${this.token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });

          if (response.status === 404) {
            console.log('Data file not found, will create on first save');
            return { gymDates: [], playlists: { 'Upper Body': [], 'Lower Body': [], 'Full Body': [] } };
          }

          if (!response.ok) {
            throw new Error('Failed to fetch from GitHub');
          }

          const data = await response.json();
          const content = JSON.parse(atob(data.content));
          this.cache = { content, sha: data.sha };
          return content;
        } catch (error) {
          console.error('GitHub fetch error, using localStorage:', error);
          return this.getLocalData();
        }
      }

      async saveData(data) {
        if (!this.token) {
          console.log('No token, saving to localStorage');
          return this.saveLocalData(data);
        }

        try {
          const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`;
          
          const payload = {
            message: 'Update gym data',
            content: btoa(JSON.stringify(data, null, 2)),
            branch: GITHUB_CONFIG.branch
          };

          if (this.cache && this.cache.sha) {
            payload.sha = this.cache.sha;
          }

          const response = await fetch(url, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${this.token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error('Failed to save to GitHub');
          }

          const result = await response.json();
          this.cache = { content: data, sha: result.content.sha };
          
          // Also save to localStorage as backup
          this.saveLocalData(data);
          return true;
        } catch (error) {
          console.error('GitHub save error, saving to localStorage:', error);
          return this.saveLocalData(data);
        }
      }

      getLocalData() {
        const gymDates = localStorage.getItem('gym-dates');
        const playlists = localStorage.getItem('playlists');
        return {
          gymDates: gymDates ? JSON.parse(gymDates) : [],
          playlists: playlists ? JSON.parse(playlists) : { 'Upper Body': [], 'Lower Body': [], 'Full Body': [] }
        };
      }

      saveLocalData(data) {
        localStorage.setItem('gym-dates', JSON.stringify(data.gymDates));
        localStorage.setItem('playlists', JSON.stringify(data.playlists));
        return true;
      }
    }

    const storage = new GitHubStorage();

    function GymTracker() {
      const [gymDates, setGymDates] = useState([]);
      const [playlists, setPlaylists] = useState({ 'Upper Body': [], 'Lower Body': [], 'Full Body': [] });
      const [currentDate, setCurrentDate] = useState(new Date());
      const [currentScreen, setCurrentScreen] = useState('home');
      const [showPlaylistEditor, setShowPlaylistEditor] = useState(false);
      const [editingPlaylist, setEditingPlaylist] = useState(null);
      const [newPlaylistName, setNewPlaylistName] = useState('');
      const [newExercise, setNewExercise] = useState({ name: '', weight: '', reps: '', sets: '' });
      const [activeWorkout, setActiveWorkout] = useState(null);
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const [streak, setStreak] = useState(0);
      const [showTokenModal, setShowTokenModal] = useState(false);
      const [tokenInput, setTokenInput] = useState('');
      const [hasToken, setHasToken] = useState(storage.hasToken());
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        setLoading(true);
        try {
          const data = await storage.getData();
          setGymDates(data.gymDates || []);
          setPlaylists(data.playlists || { 'Upper Body': [], 'Lower Body': [], 'Full Body': [] });
          calculateStreak(data.gymDates || []);
        } catch (error) {
          console.error('Error loading data:', error);
        }
        setLoading(false);
      };

      const saveAllData = async (newGymDates, newPlaylists) => {
        await storage.saveData({
          gymDates: newGymDates,
          playlists: newPlaylists
        });
      };

      const calculateStreak = (dates) => {
        if (!dates.length) { setStreak(0); return; }
        const sorted = dates.map(d => new Date(d)).sort((a, b) => b - a);
        let s = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < sorted.length; i++) {
          const check = new Date(today);
          check.setDate(check.getDate() - i);
          check.setHours(0, 0, 0, 0);
          const has = sorted.some(d => {
            const wd = new Date(d);
            wd.setHours(0, 0, 0, 0);
            return wd.getTime() === check.getTime();
          });
          if (has) s++; else break;
        }
        setStreak(s);
      };

      const saveGymDates = async (dates) => {
        await saveAllData(dates, playlists);
        calculateStreak(dates);
      };

      const savePlaylists = async (lists) => {
        await saveAllData(gymDates, lists);
      };

      const logGymToday = () => {
        const today = new Date().toDateString();
        if (!gymDates.includes(today)) {
          const newDates = [...gymDates, today];
          setGymDates(newDates);
          saveGymDates(newDates);
        }
      };

      const startWorkout = (name) => {
        setActiveWorkout(name);
        setCurrentExerciseIndex(0);
        setCurrentScreen('active-workout');
      };

      const finishWorkout = (completed) => {
        if (completed === true) logGymToday();
        setActiveWorkout(null);
        setCurrentExerciseIndex(0);
        setCurrentScreen('home');
      };

      const addPlaylist = () => {
        if (newPlaylistName.trim() && !playlists[newPlaylistName.trim()]) {
          const np = { ...playlists, [newPlaylistName.trim()]: [] };
          setPlaylists(np);
          savePlaylists(np);
          setNewPlaylistName('');
        }
      };

      const addExercise = () => {
        if (newExercise.name.trim() && editingPlaylist) {
          const up = { ...playlists };
          up[editingPlaylist] = [...up[editingPlaylist], { ...newExercise, id: Date.now() }];
          setPlaylists(up);
          savePlaylists(up);
          setNewExercise({ name: '', weight: '', reps: '', sets: '' });
        }
      };

      const updateExercise = (id, field, value) => {
        const up = { ...playlists };
        const idx = up[editingPlaylist].findIndex(ex => ex.id === id);
        if (idx !== -1) {
          up[editingPlaylist][idx][field] = value;
          setPlaylists(up);
          savePlaylists(up);
        }
      };

      const deleteExercise = (id) => {
        const up = { ...playlists };
        up[editingPlaylist] = up[editingPlaylist].filter(ex => ex.id !== id);
        setPlaylists(up);
        savePlaylists(up);
      };

      const deletePlaylist = (name) => {
        const up = { ...playlists };
        delete up[name];
        setPlaylists(up);
        savePlaylists(up);
      };

      const saveToken = () => {
        if (tokenInput.trim().startsWith('ghp_')) {
          storage.setToken(tokenInput.trim());
          setHasToken(true);
          setShowTokenModal(false);
          setTokenInput('');
          loadData();
        } else {
          alert('Invalid token. It should start with "ghp_"');
        }
      };

      const getDaysInMonth = (date) => {
        const y = date.getFullYear(), m = date.getMonth();
        const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
        return { daysInMonth: last.getDate(), startingDayOfWeek: first.getDay() };
      };

      const isGymDay = (day) => {
        const check = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        return gymDates.includes(check.toDateString());
      };

      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const s = {
        page: { minHeight: '100vh', background: '#f5f5f7', padding: '20px', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', color: '#1d1d1f' },
        container: { maxWidth: '600px', margin: '0 auto' },
        btn: { padding: '18px', fontSize: '16px', fontWeight: '500', border: 'none', borderRadius: '12px', cursor: 'pointer', transition: 'all 0.2s' },
        btnPrimary: { background: '#1d1d1f', color: '#fff' },
        btnSecondary: { background: '#fff', border: '1px solid #d2d2d7', color: '#1d1d1f' },
        card: { background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #d2d2d7', marginBottom: '20px' },
        input: { width: '100%', padding: '12px', background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', fontSize: '15px', boxSizing: 'border-box' }
      };

      if (loading) {
        return h('div', { style: { ...s.page, display: 'flex', alignItems: 'center', justifyContent: 'center' } },
          h('div', { style: { textAlign: 'center' } },
            h('div', { style: { fontSize: '48px', marginBottom: '20px' } }, 'üí™'),
            h('div', { style: { fontSize: '18px', color: '#86868b' } }, 'Loading...')
          )
        );
      }

      // Token setup modal
      if (showTokenModal) {
        return h('div', { style: { ...s.page, display: 'flex', alignItems: 'center', justifyContent: 'center' } },
          h('div', { style: { background: '#fff', borderRadius: '16px', padding: '30px', maxWidth: '500px', width: '100%', border: '1px solid #d2d2d7' } },
            h('h2', { style: { fontSize: '24px', marginBottom: '16px', fontWeight: '600' } }, 'Setup GitHub Backup'),
            h('p', { style: { fontSize: '15px', color: '#86868b', marginBottom: '20px', lineHeight: '1.5' } }, 
              'To save your data permanently to GitHub, paste your Personal Access Token below. Your data will be saved to gym-data.json in your repo.'
            ),
            h('input', { 
              type: 'password', 
              value: tokenInput, 
              onChange: e => setTokenInput(e.target.value),
              placeholder: 'ghp_xxxxxxxxxxxx',
              style: { ...s.input, marginBottom: '16px' }
            }),
            h('div', { style: { display: 'flex', gap: '12px' } },
              h('button', { onClick: saveToken, style: { ...s.btn, ...s.btnPrimary, flex: 1 } }, 'Save Token'),
              h('button', { onClick: () => setShowTokenModal(false), style: { ...s.btn, ...s.btnSecondary } }, 'Skip')
            )
          )
        );
      }

      if (currentScreen === 'home') {
        const streakCard = streak > 0 ? h('div', { style: { ...s.card, textAlign: 'center' } },
          h('div', { style: { fontSize: '48px', marginBottom: '8px' } }, 'üî•'),
          h('div', { style: { fontSize: '32px', fontWeight: '600', marginBottom: '4px' } }, String(streak) + ' Day Streak'),
          h('div', { style: { fontSize: '14px', color: '#86868b' } }, 'Keep it going!')
        ) : null;

        const statsCard = gymDates.length > 0 ? h('div', { style: { ...s.card, textAlign: 'center' } },
          h('div', { style: { fontSize: '36px', fontWeight: '600', marginBottom: '4px' } }, String(gymDates.length)),
          h('div', { style: { fontSize: '14px', color: '#86868b' } }, 'Total Sessions')
        ) : null;

        const backupBanner = !hasToken ? h('div', { 
          onClick: () => setShowTokenModal(true),
          style: { ...s.card, background: '#fff3cd', border: '1px solid #ffc107', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '12px' } 
        },
          h('span', { style: { fontSize: '24px' } }, '‚ö†Ô∏è'),
          h('div', { style: { flex: 1 } },
            h('div', { style: { fontWeight: '600', marginBottom: '4px' } }, 'Setup GitHub Backup'),
            h('div', { style: { fontSize: '14px', color: '#856404' } }, 'Tap to save your data permanently')
          )
        ) : null;

        const emptyDays = [];
        for (let i = 0; i < startingDayOfWeek; i++) {
          emptyDays.push(h('div', { key: 'e' + i }));
        }

        const monthDays = [];
        for (let i = 0; i < daysInMonth; i++) {
          const day = i + 1;
          const isGym = isGymDay(day);
          monthDays.push(h('div', { 
            key: day, 
            style: { 
              aspectRatio: '1', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center', 
              borderRadius: '8px', 
              background: isGym ? '#34c759' : 'transparent', 
              color: isGym ? '#fff' : '#1d1d1f', 
              fontSize: '15px', 
              fontWeight: isGym ? '600' : '400' 
            } 
          }, String(day)));
        }

        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { textAlign: 'center', marginBottom: '40px', paddingTop: '20px' } },
              h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: '12px', marginBottom: '8px' } },
                h('span', { style: { fontSize: '32px' } }, 'üí™'),
                h('h1', { style: { fontSize: '32px', margin: 0, fontWeight: '600', letterSpacing: '-0.5px' } }, 'Gym Tracker')
              ),
              h('p', { style: { fontSize: '14px', color: '#86868b', margin: 0 } }, 'Track your workouts')
            ),
            backupBanner,
            streakCard,
            h('div', { style: { marginBottom: '30px', display: 'flex', gap: '12px' } },
              h('button', { onClick: () => setCurrentScreen('select-workout'), style: { ...s.btn, ...s.btnPrimary, flex: 1 } }, 'Start Workout'),
              h('button', { onClick: () => setCurrentScreen('edit-playlists'), style: { ...s.btn, ...s.btnSecondary } }, '‚öôÔ∏è')
            ),
            h('div', { style: s.card },
              h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
                h('button', { 
                  onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)), 
                  style: { background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', padding: '8px 12px', cursor: 'pointer', fontSize: '18px' } 
                }, '‚óÄ'),
                h('h2', { style: { fontSize: '18px', margin: 0, fontWeight: '600' } }, monthNames[currentDate.getMonth()] + ' ' + String(currentDate.getFullYear())),
                h('button', { 
                  onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)), 
                  style: { background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', padding: '8px 12px', cursor: 'pointer', fontSize: '18px' } 
                }, '‚ñ∂')
              ),
              h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px', marginBottom: '8px' } },
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => 
                  h('div', { key: i, style: { textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#86868b', padding: '8px 0' } }, d)
                )
              ),
              h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' } },
                emptyDays.concat(monthDays)
              )
            ),
            statsCard
          )
        );
      }

      if (currentScreen === 'select-workout') {
        const playlistButtons = Object.keys(playlists).map(name =>
          h('button', { 
            key: name, 
            onClick: () => startWorkout(name), 
            disabled: playlists[name].length === 0, 
            style: { 
              width: '100%', 
              background: '#fff', 
              border: '1px solid #d2d2d7', 
              borderRadius: '12px', 
              padding: '20px', 
              marginBottom: '12px', 
              cursor: playlists[name].length > 0 ? 'pointer' : 'not-allowed', 
              textAlign: 'left', 
              opacity: playlists[name].length > 0 ? 1 : 0.5 
            } 
          },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
              h('div', null,
                h('div', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '4px', color: '#1d1d1f' } }, name),
                h('div', { style: { fontSize: '14px', color: '#86868b' } }, String(playlists[name].length) + ' exercises')
              ),
              playlists[name].length > 0 ? h('span', { style: { fontSize: '24px' } }, '‚ñ∂Ô∏è') : null
            )
          )
        );

        const noWorkouts = Object.keys(playlists).every(n => playlists[n].length === 0) ? 
          h('div', { style: { textAlign: 'center', padding: '40px 20px', color: '#86868b' } },
            h('p', { style: { marginBottom: '16px' } }, 'No workouts created yet'),
            h('button', { onClick: () => setCurrentScreen('edit-playlists'), style: { ...s.btn, ...s.btnPrimary } }, 'Create Your First Workout')
          ) : null;

        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { display: 'flex', alignItems: 'center', marginBottom: '30px', paddingTop: '20px' } },
              h('button', { 
                onClick: () => setCurrentScreen('home'), 
                style: { background: 'none', border: 'none', cursor: 'pointer', padding: '8px', marginRight: '12px', fontSize: '24px' } 
              }, '‚Üê'),
              h('h1', { style: { fontSize: '28px', margin: 0, fontWeight: '600' } }, 'Select Workout')
            ),
            playlistButtons,
            noWorkouts
          )
        );
      }

      return h('div', { style: s.page },
        h('div', { style: s.container },
          h('h1', null, 'Screen: ' + currentScreen),
          h('button', { 
            onClick: () => setCurrentScreen('home'), 
            style: { ...s.btn, ...s.btnPrimary, marginTop: '20px' } 
          }, 'Back to Home')
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(h(GymTracker));
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    }
  </script>
</body>
</html>
