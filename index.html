<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f5f5f7">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gym Tracker">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <title>Gym Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }
    #root { min-height: 100vh; }
    input, button, textarea { -webkit-appearance: none; appearance: none; }
    button:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script>
    const { useState, useEffect, createElement: h } = React;
    
    if (!window.storage) {
      window.storage = {
        async get(key) {
          const value = localStorage.getItem(key);
          return value ? { key, value } : null;
        },
        async set(key, value) {
          localStorage.setItem(key, value);
          return { key, value };
        }
      };
    }

    function GymTracker() {
      const [gymDates, setGymDates] = useState([]);
      const [playlists, setPlaylists] = useState({ 'Upper Body': [], 'Lower Body': [], 'Full Body': [] });
      const [currentDate, setCurrentDate] = useState(new Date());
      const [currentScreen, setCurrentScreen] = useState('home');
      const [showPlaylistEditor, setShowPlaylistEditor] = useState(false);
      const [editingPlaylist, setEditingPlaylist] = useState(null);
      const [newPlaylistName, setNewPlaylistName] = useState('');
      const [newExercise, setNewExercise] = useState({ name: '', weight: '', reps: '', sets: '' });
      const [activeWorkout, setActiveWorkout] = useState(null);
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const [streak, setStreak] = useState(0);

      useEffect(() => {
        (async () => {
          try {
            const dr = await window.storage.get('gym-dates');
            if (dr) {
              const dates = JSON.parse(dr.value);
              setGymDates(dates);
              calculateStreak(dates);
            }
          } catch (e) {}
          try {
            const pr = await window.storage.get('playlists');
            if (pr) setPlaylists(JSON.parse(pr.value));
          } catch (e) {}
        })();
      }, []);

      const calculateStreak = (dates) => {
        if (!dates.length) { setStreak(0); return; }
        const sorted = dates.map(d => new Date(d)).sort((a, b) => b - a);
        let streak = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < sorted.length; i++) {
          const check = new Date(today);
          check.setDate(check.getDate() - i);
          check.setHours(0, 0, 0, 0);
          const has = sorted.some(d => {
            const wd = new Date(d);
            wd.setHours(0, 0, 0, 0);
            return wd.getTime() === check.getTime();
          });
          if (has) streak++; else break;
        }
        setStreak(streak);
      };

      const saveGymDates = async (dates) => {
        await window.storage.set('gym-dates', JSON.stringify(dates));
        calculateStreak(dates);
      };

      const savePlaylists = async (lists) => {
        await window.storage.set('playlists', JSON.stringify(lists));
      };

      const logGymToday = () => {
        const today = new Date().toDateString();
        if (!gymDates.includes(today)) {
          const newDates = [...gymDates, today];
          setGymDates(newDates);
          saveGymDates(newDates);
        }
      };

      const startWorkout = (name) => {
        setActiveWorkout(name);
        setCurrentExerciseIndex(0);
        setCurrentScreen('active-workout');
      };

      const finishWorkout = (completed = false) => {
        if (completed) logGymToday();
        setActiveWorkout(null);
        setCurrentExerciseIndex(0);
        setCurrentScreen('home');
      };

      const addPlaylist = () => {
        if (newPlaylistName.trim() && !playlists[newPlaylistName.trim()]) {
          const np = { ...playlists, [newPlaylistName.trim()]: [] };
          setPlaylists(np);
          savePlaylists(np);
          setNewPlaylistName('');
        }
      };

      const addExercise = () => {
        if (newExercise.name.trim() && editingPlaylist) {
          const up = { ...playlists };
          up[editingPlaylist] = [...up[editingPlaylist], { ...newExercise, id: Date.now() }];
          setPlaylists(up);
          savePlaylists(up);
          setNewExercise({ name: '', weight: '', reps: '', sets: '' });
        }
      };

      const updateExercise = (id, field, value) => {
        const up = { ...playlists };
        const idx = up[editingPlaylist].findIndex(ex => ex.id === id);
        if (idx !== -1) {
          up[editingPlaylist][idx][field] = value;
          setPlaylists(up);
          savePlaylists(up);
        }
      };

      const deleteExercise = (id) => {
        const up = { ...playlists };
        up[editingPlaylist] = up[editingPlaylist].filter(ex => ex.id !== id);
        setPlaylists(up);
        savePlaylists(up);
      };

      const deletePlaylist = (name) => {
        const up = { ...playlists };
        delete up[name];
        setPlaylists(up);
        savePlaylists(up);
      };

      const getDaysInMonth = (date) => {
        const y = date.getFullYear(), m = date.getMonth();
        const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
        return { daysInMonth: last.getDate(), startingDayOfWeek: first.getDay() };
      };

      const isGymDay = (day) => {
        const check = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        return gymDates.includes(check.toDateString());
      };

      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const s = {
        page: { minHeight: '100vh', background: '#f5f5f7', padding: '20px', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', color: '#1d1d1f' },
        container: { maxWidth: '600px', margin: '0 auto' },
        btn: { padding: '18px', fontSize: '16px', fontWeight: '500', border: 'none', borderRadius: '12px', cursor: 'pointer', transition: 'all 0.2s' },
        btnPrimary: { background: '#1d1d1f', color: '#fff' },
        btnSecondary: { background: '#fff', border: '1px solid #d2d2d7', color: '#1d1d1f' },
        card: { background: '#fff', borderRadius: '12px', padding: '20px', border: '1px solid #d2d2d7', marginBottom: '20px' },
        input: { width: '100%', padding: '12px', background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', fontSize: '15px', boxSizing: 'border-box' }
      };

      if (currentScreen === 'home') {
        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { textAlign: 'center', marginBottom: '40px', paddingTop: '20px' } },
              h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: '12px', marginBottom: '8px' } },
                h('span', { style: { fontSize: '32px' } }, 'ðŸ’ª'),
                h('h1', { style: { fontSize: '32px', margin: 0, fontWeight: '600', letterSpacing: '-0.5px' } }, 'Gym Tracker')
              ),
              h('p', { style: { fontSize: '14px', color: '#86868b', margin: 0 } }, 'Track your workouts')
            ),
            streak > 0 && h('div', { style: { ...s.card, textAlign: 'center' } },
              h('div', { style: { fontSize: '48px', marginBottom: '8px' } }, 'ðŸ”¥'),
              h('div', { style: { fontSize: '32px', fontWeight: '600', marginBottom: '4px' } }, streak + ' Day Streak'),
              h('div', { style: { fontSize: '14px', color: '#86868b' } }, 'Keep it going!')
            ),
            h('div', { style: { marginBottom: '30px', display: 'flex', gap: '12px' } },
              h('button', { onClick: () => setCurrentScreen('select-workout'), style: { ...s.btn, ...s.btnPrimary, flex: 1 } }, 'Start Workout'),
              h('button', { onClick: () => setCurrentScreen('edit-playlists'), style: { ...s.btn, ...s.btnSecondary } }, 'âš™ï¸')
            ),
            h('div', { style: s.card },
              h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
                h('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1)), style: { background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', padding: '8px 12px', cursor: 'pointer', fontSize: '18px' } }, 'â—€'),
                h('h2', { style: { fontSize: '18px', margin: 0, fontWeight: '600' } }, monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear()),
                h('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)), style: { background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', padding: '8px 12px', cursor: 'pointer', fontSize: '18px' } }, 'â–¶')
              ),
              h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px', marginBottom: '8px' } },
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => h('div', { key: i, style: { textAlign: 'center', fontSize: '12px', fontWeight: '600', color: '#86868b', padding: '8px 0' } }, d))
              ),
              h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' } },
                [...Array(startingDayOfWeek)].map((_, i) => h('div', { key: 'e' + i })),
                [...Array(daysInMonth)].map((_, i) => {
                  const day = i + 1, isGym = isGymDay(day);
                  return h('div', { key: day, style: { aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '8px', background: isGym ? '#34c759' : 'transparent', color: isGym ? '#fff' : '#1d1d1f', fontSize: '15px', fontWeight: isGym ? '600' : '400' } }, day);
                })
              )
            ),
            gymDates.length > 0 && h('div', { style: { ...s.card, textAlign: 'center' } },
              h('div', { style: { fontSize: '36px', fontWeight: '600', marginBottom: '4px' } }, gymDates.length),
              h('div', { style: { fontSize: '14px', color: '#86868b' } }, 'Total Sessions')
            )
          )
        );
      }

      if (currentScreen === 'edit-playlists') {
        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { display: 'flex', alignItems: 'center', marginBottom: '30px', paddingTop: '20px' } },
              h('button', { onClick: () => setCurrentScreen('home'), style: { background: 'none', border: 'none', cursor: 'pointer', padding: '8px', marginRight: '12px', fontSize: '24px' } }, 'â†'),
              h('h1', { style: { fontSize: '28px', margin: 0, fontWeight: '600' } }, 'Edit Workouts')
            ),
            Object.keys(playlists).map(name =>
              h('div', { key: name, style: s.card },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                  h('div', null,
                    h('div', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '4px' } }, name),
                    h('div', { style: { fontSize: '14px', color: '#86868b' } }, playlists[name].length + ' exercises')
                  ),
                  h('div', { style: { display: 'flex', gap: '8px' } },
                    h('button', { onClick: () => { setEditingPlaylist(name); setShowPlaylistEditor(true); }, style: { padding: '10px 14px', background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', cursor: 'pointer', fontSize: '16px' } }, 'âœï¸'),
                    h('button', { onClick: () => confirm('Delete "' + name + '"?') && deletePlaylist(name), style: { padding: '10px 14px', background: '#f5f5f7', border: '1px solid #d2d2d7', borderRadius: '8px', cursor: 'pointer', fontSize: '16px' } }, 'ðŸ—‘ï¸')
                  )
                )
              )
            ),
            h('div', { style: s.card },
              h('h2', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px' } }, 'Create New Playlist'),
              h('input', { type: 'text', value: newPlaylistName, onChange: e => setNewPlaylistName(e.target.value), onKeyPress: e => e.key === 'Enter' && addPlaylist(), placeholder: 'Playlist name', style: { ...s.input, marginBottom: '12px' } }),
              h('button', { onClick: addPlaylist, disabled: !newPlaylistName.trim(), style: { ...s.btn, width: '100%', background: newPlaylistName.trim() ? '#1d1d1f' : '#d2d2d7', color: '#fff', cursor: newPlaylistName.trim() ? 'pointer' : 'not-allowed' } }, 'Create Playlist')
            ),
            showPlaylistEditor && h('div', { style: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }, onClick: () => setShowPlaylistEditor(false) },
              h('div', { style: { background: '#fff', borderRadius: '16px', padding: '24px', maxWidth: '500px', width: '100%', maxHeight: '80vh', overflow: 'auto' }, onClick: e => e.stopPropagation() },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
                  h('h2', { style: { fontSize: '20px', margin: 0, fontWeight: '600' } }, editingPlaylist),
                  h('button', { onClick: () => { setShowPlaylistEditor(false); setEditingPlaylist(null); }, style: { background: 'none', border: 'none', cursor: 'pointer', padding: '4px', fontSize: '24px', color: '#86868b' } }, 'Ã—')
                ),
                h('div', { style: { marginBottom: '20px' } },
                  playlists[editingPlaylist]?.map(ex =>
                    h('div', { key: ex.id, style: { background: '#f5f5f7', borderRadius: '8px', padding: '12px', marginBottom: '12px', border: '1px solid #d2d2d7' } },
                      h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '8px' } },
                        h('input', { type: 'text', value: ex.name, onChange: e => updateExercise(ex.id, 'name', e.target.value), style: { flex: 1, background: 'transparent', border: 'none', fontSize: '15px', fontWeight: '500', padding: '4px 0' } }),
                        h('button', { onClick: () => deleteExercise(ex.id), style: { background: 'none', border: 'none', cursor: 'pointer', padding: '4px', fontSize: '16px' } }, 'ðŸ—‘ï¸')
                      ),
                      h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' } },
                        ['weight', 'reps', 'sets'].map(field =>
                          h('div', { key: field },
                            h('label', { style: { fontSize: '12px', color: '#86868b', display: 'block', marginBottom: '4px' } }, field.charAt(0).toUpperCase() + field.slice(1)),
                            h('input', { type: 'text', value: ex[field], onChange: e => updateExercise(ex.id, field, e.target.value), placeholder: field === 'weight' ? '0 lbs' : '0', style: { width: '100%', padding: '6px 8px', background: '#fff', border: '1px solid #d2d2d7', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' } })
                          )
                        )
                      )
                    )
                  )
                ),
                h('div', { style: { paddingTop: '20px', borderTop: '1px solid #d2d2d7' } },
                  h('h3', { style: { fontSize: '16px', fontWeight: '600', marginBottom: '12px' } }, 'Add Exercise'),
                  h('input', { type: 'text', value: newExercise.name, onChange: e => setNewExercise({ ...newExercise, name: e.target.value }), placeholder: 'Exercise name', style: { ...s.input, marginBottom: '8px' } }),
                  h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', marginBottom: '12px' } },
                    ['weight', 'reps', 'sets'].map(field =>
                      h('input', { key: field, type: 'text', value: newExercise[field], onChange: e => setNewExercise({ ...newExercise, [field]: e.target.value }), placeholder: field.charAt(0).toUpperCase() + field.slice(1), style: s.input })
                    )
                  ),
                  h('button', { onClick: addExercise, disabled: !newExercise.name.trim(), style: { ...s.btn, width: '100%', background: newExercise.name.trim() ? '#1d1d1f' : '#d2d2d7', color: '#fff', cursor: newExercise.name.trim() ? 'pointer' : 'not-allowed' } }, 'Add Exercise')
                )
              )
            )
          )
        );
      }

      if (currentScreen === 'select-workout') {
        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { display: 'flex', alignItems: 'center', marginBottom: '30px', paddingTop: '20px' } },
              h('button', { onClick: () => setCurrentScreen('home'), style: { background: 'none', border: 'none', cursor: 'pointer', padding: '8px', marginRight: '12px', fontSize: '24px' } }, 'â†'),
              h('h1', { style: { fontSize: '28px', margin: 0, fontWeight: '600' } }, 'Select Workout')
            ),
            Object.keys(playlists).map(name =>
              h('button', { key: name, onClick: () => startWorkout(name), disabled: !playlists[name].length, style: { width: '100%', background: '#fff', border: '1px solid #d2d2d7', borderRadius: '12px', padding: '20px', marginBottom: '12px', cursor: playlists[name].length ? 'pointer' : 'not-allowed', textAlign: 'left', opacity: playlists[name].length ? 1 : 0.5 } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                  h('div', null,
                    h('div', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '4px', color: '#1d1d1f' } }, name),
                    h('div', { style: { fontSize: '14px', color: '#86868b' } }, playlists[name].length + ' exercises')
                  ),
                  playlists[name].length > 0 && h('span', { style: { fontSize: '24px' } }, 'â–¶ï¸')
                )
              )
            ),
            Object.keys(playlists).every(n => !playlists[n].length) && h('div', { style: { textAlign: 'center', padding: '40px 20px', color: '#86868b' } },
              h('p', { style: { marginBottom: '16px' } }, 'No workouts created yet'),
              h('button', { onClick: () => setCurrentScreen('edit-playlists'), style: { ...s.btn, ...s.btnPrimary } }, 'Create Your First Workout')
            )
          )
        );
      }

      if (currentScreen === 'active-workout' && activeWorkout) {
        const exercises = playlists[activeWorkout];
        const ex = exercises[currentExerciseIndex];
        const prog = ((currentExerciseIndex + 1) / exercises.length) * 100;
        return h('div', { style: s.page },
          h('div', { style: s.container },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px', paddingTop: '20px' } },
              h('h1', { style: { fontSize: '24px', margin: 0, fontWeight: '600' } }, activeWorkout),
              h('button', { onClick: () => finishWorkout(false), style: { padding: '8px 16px', background: '#1d1d1f', border: 'none', borderRadius: '8px', color: '#fff', cursor: 'pointer', fontSize: '14px', fontWeight: '500' } }, 'Finish')
            ),
            h('div', { style: { background: '#d2d2d7', borderRadius: '8px', height: '8px', marginBottom: '30px', overflow: 'hidden' } },
              h('div', { style: { background: '#1d1d1f', height: '100%', width: prog + '%', transition: 'width 0.3s' } })
            ),
            h('div', { style: { ...s.card, padding: '32px', textAlign: 'center' } },
              h('div', { style: { fontSize: '14px', color: '#86868b', marginBottom: '12px' } }, 'Exercise ' + (currentExerciseIndex + 1) + ' of ' + exercises.length),
              h('h2', { style: { fontSize: '32px', fontWeight: '600', marginBottom: '32px' } }, ex.name),
              h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px' } },
                ['weight', 'reps', 'sets'].map(f =>
                  h('div', { key: f },
                    h('div', { style: { fontSize: '14px', color: '#86868b', marginBottom: '8px' } }, f.charAt(0).toUpperCase() + f.slice(1)),
                    h('div', { style: { fontSize: '28px', fontWeight: '600' } }, ex[f] || '-')
                  )
                )
              )
            ),
            h('div', { style: { display: 'flex', gap: '12px' } },
              h('button', { onClick: () => setCurrentExerciseIndex(i => i - 1), disabled: currentExerciseIndex === 0, style: { ...s.btn, flex: 1, background: currentExerciseIndex === 0 ? '#f5f5f7' : '#fff', border: '1px solid #d2d2d7', color: currentExerciseIndex === 0 ? '#86868b' : '#1d1d1f', cursor: currentExerciseIndex === 0 ? 'not-allowed' : 'pointer' } }, 'â—€ Previous'),
              h('button', { onClick: () => currentExerciseIndex === exercises.length - 1 ? finishWorkout(true) : setCurrentExerciseIndex(i => i + 1), style: { ...s.btn, ...s.btnPrimary, flex: 1 } }, currentExerciseIndex === exercises.length - 1 ? 'âœ“ Complete' : 'Next â–¶')
            ),
            h('div', { style: { ...s.card, marginTop: '30px' } },
              h('h3', { style: { fontSize: '16px', fontWeight: '600', marginBottom: '16px' } }, 'Remaining Exercises'),
              exercises.map((e, i) =>
                h('div', { key: e.id, style: { padding: '12px', borderRadius: '8px', marginBottom: '8px', background: i === currentExerciseIndex ? '#f5f5f7' : 'transparent', opacity: i < currentExerciseIndex ? 0.4 : 1, display: 'flex', alignItems: 'center', gap: '12px' } },
                  h('div', { style: { width: '24px', height: '24px', borderRadius: '50%', background: i < currentExerciseIndex ? '#1d1d1f' : i === currentExerciseIndex ? '#1d1d1f' : '#d2d2d7', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '600' } }, i < currentExerciseIndex ? 'âœ“' : i + 1),
                  h('div', { style: { fontSize: '15px', fontWeight: i === currentExerciseIndex ? '600' : '400' } }, e.name)
                )
              )
            )
          )
        );
      }

      return null;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(h(GymTracker));
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    }
  </script>
</body>
</html>
